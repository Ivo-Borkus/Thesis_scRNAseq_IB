
```{R processing seurat}
Idents(seurat_obj) <- "generalised_ann_1"
seurat_obj <- subset(x = seurat_obj, idents = cell_type_of_interest, invert = F)
reduction_name <- paste0(dataset, "_im_", cell_type_of_interest)
seurat_obj[["RNA"]] <- split(seurat_obj[["RNA"]], f = seurat_obj@meta.data[[sample_col]])

seurat_obj <- FindVariableFeatures(seurat_obj, selection.method = "vst", nfeatures = 2000, verbose = TRUE)
hvf_info <- HVFInfo(seurat_obj)
top_variable_genes <- hvf_info[order(hvf_info$variance.standardized, decreasing = TRUE), ]
top_2000_genes <- rownames(top_variable_genes)[1:2000]
VariableFeatures(seurat_obj) <- top_2000_genes
all.genes <- rownames(seurat_obj)
seurat_obj <- ScaleData(object = seurat_obj, vars.to.regress = c("percent_mt"), features = top_2000_genes, verbose = FALSE)
seurat_obj <- RunPCA(
    object = seurat_obj, nfeatures.print = 5, ndims.print = 1:2, reduction.name = paste0("pca_", reduction_name)
)
ElbowPlot(seurat_obj, reduction = paste0("pca_", reduction_name), ndims = 100)
VizDimLoadings(seurat_obj, dims = 1:5, reduction = paste0("pca_", reduction_name), nfeatures = 15)

seurat_obj <- IntegrateLayers(
    object = seurat_obj, method = HarmonyIntegration,
    orig.reduction = paste0("pca_", reduction_name), new.reduction = paste0("harmony_pca.", reduction_name),
    verbose = TRUE
)
seurat_obj <- FindNeighbors(seurat_obj, reduction = paste0("harmony_pca.", reduction_name), dims = 1:25)
seurat_obj <- RunUMAP(seurat_obj, reduction = paste0("harmony_pca.", reduction_name), dims = 1:25, reduction.name = paste0("umap.harmony.", reduction_name))

seurat_obj <- JoinLayers(seurat_obj)
```



