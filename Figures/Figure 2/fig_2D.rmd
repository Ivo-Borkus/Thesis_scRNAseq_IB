---
title: "2-D"
author: "Ivo Borkus"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:  
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "/scratch_isilon/groups/singlecell/iborkus/Projects/brain_met") # nolint
knitr::opts_chunk$set(warning = FALSE, fig.width = 15, fig.height = 15)
```

# Loading packages

```{R loading libraries, include = FALSE}
library(Seurat)
# devtools::install_github("immunogenomics/lisi")
library(dplyr)
library(ggplot2)
library(purrr)
library(here)
library(tidyr)
library(ggrepel)
library(gridExtra)
library(patchwork)
library(dittoSeq)
suppressPackageStartupMessages(library(SCpubr))


setwd("/scratch_isilon/groups/singlecell/iborkus/Projects/brain_met")
input_data <- "02_scripts/overview_analysis/01_Figure/data/"
output_figs <- "02_scripts/overview_analysis/02_Figure/figs/"
```

# Loading seurat object
```{R loading seurat}
seurat_obj <- readRDS(file = paste0(input_data, "seurat_annotated_correctly.rds"))
```


```{R subsetting immune}
seurat_obj <- subset(seurat_obj, subset = ann_general_immune %in% c("Not-annotated"), invert = TRUE)
```

```{R making reduction to use}
reduction_name <- "Plotting_general_immune"
sample_col <- "primary_sample"
Idents(seurat_obj) <- "ann_general_immune"
features <- 2000

seurat_obj[["RNA"]] <- split(seurat_obj[["RNA"]], f = seurat_obj@meta.data[[sample_col]])
seurat_obj <- FindVariableFeatures(seurat_obj, selection.method = "vst", nfeatures = features, verbose = TRUE)
hvf_info <- HVFInfo(seurat_obj)
top_variable_genes <- hvf_info[order(hvf_info$variance.standardized, decreasing = TRUE), ]
top_x_genes <- rownames(top_variable_genes)[1:features]
VariableFeatures(seurat_obj) <- top_x_genes
seurat_obj <- ScaleData(object = seurat_obj, vars.to.regress = c("percent_mt"), features = top_x_genes, verbose = FALSE)
seurat_obj <- RunPCA(
    object = seurat_obj, nfeatures.print = 5, ndims.print = 1:2, reduction.name = paste0("pca_", reduction_name)
)
print(ElbowPlot(seurat_obj, reduction = paste0("pca_", reduction_name), ndims = 100))
print(VizDimLoadings(seurat_obj, dims = 1:5, reduction = paste0("pca_", reduction_name), nfeatures = 15))
seurat_obj <- FindNeighbors(seurat_obj, reduction = paste0("pca_", reduction_name), dims = 1:25) #
seurat_obj <- RunUMAP(seurat_obj, reduction = paste0("pca_", reduction_name), dims = 1:25, reduction.name = paste0("umap_", reduction_name))

seurat_obj <- IntegrateLayers(
    object = seurat_obj, method = HarmonyIntegration,
    orig.reduction = paste0("pca_", reduction_name), new.reduction = paste0("harmony_pca.", reduction_name),
    verbose = TRUE
)
seurat_obj <- FindNeighbors(seurat_obj, reduction = paste0("harmony_pca.", reduction_name), dims = 1:25)
seurat_obj <- RunUMAP(seurat_obj, reduction = paste0("harmony_pca.", reduction_name), dims = 1:25, reduction.name = paste0("umap.harmony.", reduction_name))
seurat_obj <- JoinLayers(seurat_obj)
```
```{R}
plot_general_ann <- dittoDimPlot(seurat_obj, reduction.use = paste0("umap.harmony.", reduction_name), var = "ann_general_immune", do.label = F)
plot_general_ann %>% print()
```


```{R}
ann_levels <- c(
    "Naive_Tcells", "Effector_CD8_Tcells", "Effector_memory_CD8_Tcells", "Exhausted_CD8_Tcells", "Texterm_CD8", "GD_NKT_CD8_Tcells",
    "Active_Tcells", "IFN_response_Tcells", "Helper_Tcells", "Regulatory_Tcells",
    "Proliferating_CD8_Tcells", "Proliferating_CD4_Tcells",
    "NK"
)
seurat_obj_Tcells <- subset(seurat_obj, subset = ann_lvl_1_total == "T-cells")
seurat_obj_Tcells$ann_T_1 <- factor(seurat_obj_Tcells$ann_T_1, levels = ann_levels)

plot_t_ann <- dittoDimPlot(seurat_obj_Tcells, reduction.use = paste0("umap.harmony.", reduction_name), var = "ann_T_1", do.label = F)
plot_t_ann

ggsave(paste0(output_figs, "umap_ann_T_1.png"))
```


```{R subsetting seurat for Tcells}
seurat_obj$ann_general_immune %>% table()
ann_levels <- c(
    "Naive_Tcells", "Effector_CD8_Tcells", "Effector_memory_CD8_Tcells", "Exhausted_CD8_Tcells", "Texterm_CD8", "GD_NKT_CD8_Tcells",
    "Active_Tcells", "IFN_response_Tcells", "Helper_Tcells", "Regulatory_Tcells",
    "Proliferating_CD8_Tcells", "Proliferating_CD4_Tcells",
    "NK"
)



seurat_obj_Tcells
seurat_obj_Tcells <- subset(seurat_obj, subset = ann_lvl_1_total == "T-cells")
seurat_obj_Tcells$ann_T_1 <- ifelse(seurat_obj_Tcells$ann_T_1 == "NK", "NK ", as.character(seurat_obj_Tcells$ann_T_1))
seurat_obj_Tcells$ann_T_1 <- ifelse(seurat_obj_Tcells$ann_T_1 == "Naive_Tcells", "Naive_Tcells ", as.character(seurat_obj_Tcells$ann_T_1))
seurat_obj_Tcells$ann_T_1 <- factor(seurat_obj_Tcells$ann_T_1, levels = ann_levels)

seurat_obj_Tcells$ann_T_1 %>% unique() %in% ann_levels
# levels(seurat_obj_Tcells$ann_T_1)
#     seurat_obj_Tcells$ann_T_1 %>% levels()
p1 <- SCpubr::do_AlluvialPlot(
    sample = seurat_obj_Tcells,
    first_group = "ann_lvl_1_total",
    middle_groups = "ann_general_immune",
    last_group = "ann_T_1"
) + labs(title = "Sankey plot")
p1
seurat_obj_Tcells$ann_T_1 %>% head(n = 20)
ggsave(plot = p1, "02_scripts/overview_analysis/composition/figs/sankey-all_anns.png", width = 15, height = 15)
```


```{R chatgpt}
df_freq <- as.data.frame(table(seurat_obj_Tcells$ann_lvl_1_total, seurat_obj_Tcells$ann_T_1))
colnames(df_freq) <- c("ann1", "ann2", "Freq")

library(ggalluvial)
ggplot(
    df_freq,
    aes(axis1 = ann1, axis2 = ann2, y = Freq)
) +
    geom_alluvium(aes(fill = ann2), width = 1 / 12) +
    geom_stratum(width = 1 / 12, fill = "grey") +
    geom_text(stat = "stratum", aes(label = after_stat(stratum))) +
    scale_x_discrete(limits = c("Annotation 1", "Annotation 2"), expand = c(.1, .1)) +
    theme_minimal() +
    labs(
        title = "Alluvial plot of T cell subsets",
        y = "Number of cells"
    )
```