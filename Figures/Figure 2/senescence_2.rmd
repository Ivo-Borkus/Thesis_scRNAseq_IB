
---
title: "2-B"
author: "Ivo Borkus"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:  
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "/scratch_isilon/groups/singlecell/iborkus/Projects/brain_met") # nolint
knitr::opts_chunk$set(warning = FALSE, fig.width = 15, fig.height = 15)
```

# Loading packages

```{R loading libraries, include = FALSE}
library(Seurat)
# devtools::install_github("immunogenomics/lisi")
# library(lisi)
library(dplyr)
library(ggplot2)
# library(purrr)
# library(here)
# library(tidyr)
library(ggrepel)
library(gridExtra)
# library(patchwork)
# library(dittoSeq)
library(UCell)
library(reticulate)

setwd("/scratch_isilon/groups/singlecell/iborkus/Projects/brain_met")
input_data <- "02_scripts/overview_analysis/01_Figure/data/"
output_figs <- "02_scripts/overview_analysis/02_Figure/figs/"
```

# Loading seurat object
```{R loading seurat}
seurat_obj_Tcells <- readRDS(file = paste0(input_data, "processed_Tcells_annotated_Fig_2B.rds"))
reduction_name <- "Tcells"
```


```{R vulcano_plot }
volcano_plotting <- function(marker_list, ident.1 = "", ident.2 = "") {
    marker_list$genes <- row.names(marker_list)
    marker_list$diffexpressed <- "NO"
    marker_list$diffexpressed[marker_list$avg_log2FC > 1.5 & marker_list$p_val < 0.05] <- "UP"
    marker_list$diffexpressed[marker_list$avg_log2FC < -1.5 & marker_list$p_val < 0.05] <- "DOWN"
    marker_list$diffexpressed[marker_list$avg_log2FC > 1.5 & marker_list$p_val < 0.05] <- "UP"
    marker_list$diffexpressed[marker_list$avg_log2FC < -1.5 & marker_list$p_val < 0.05] <- "DOWN"
    # marker_list$delabel <- NA
    # marker_list$delabel[marker_list$diffexpressed != "NO"] <- row.names(marker_list)[marker_list$diffexpressed != "NO"]

    marker_list$delabel <- NA
    marker_list$delabel[marker_list$diffexpressed != "NO"] <- row.names(marker_list)[marker_list$diffexpressed != "NO"]
    marker_list %>%
        arrange(desc(avg_log2FC)) %>%
        dplyr::select(avg_log2FC) %>%
        head(, n = 10) %>%
        row.names() -> labels_1
    marker_list %>%
        arrange(avg_log2FC) %>%
        dplyr::select(avg_log2FC) %>%
        head(, n = 10) %>%
        row.names() -> labels_2
    labels <- c(labels_1, labels_2)
    marker_list$delabel <- NA
    marker_list$delabel[marker_list$genes %in% labels] <- marker_list$genes[marker_list$genes %in% labels]
    min_above <- min(marker_list$p_val[marker_list$p_val > 0])
    marker_list$p_val <- ifelse(marker_list$p_val == 0, min_above, marker_list$p_val)
    volcano_plot <- ggplot(data = marker_list, aes(x = avg_log2FC, y = -log10(p_val), col = diffexpressed, label = delabel)) +
        geom_point() +
        geom_text_repel(max.overlaps = Inf) +
        scale_color_manual(values = c("blue", "black", "red")) +
        geom_vline(xintercept = c(-1.5, 1.5), col = "red") +
        geom_hline(yintercept = -log10(0.05), col = "red") & labs(title = paste0("Comparing: ", ident.1, " versus the ", ident.2))
    return(volcano_plot)
}
```

```{R}
# install.packages("BiocManager") # Needed to install all Bioconductor packages
# BiocManager::install("MAST")
Idents(seurat_obj_Tcells) <- "cells_of_interest"
library(MAST)

# pseudobulk the counts based on donor-condition-celltype
pseudo_seurat <- AggregateExpression(seurat_obj_Tcells, assays = "RNA", return.seurat = T, group.by = c("primary_sample", "cells_of_interest"))
Idents(pseudo_seurat) <- "cells_of_interest"
marker_list <- FindMarkers(pseudo_seurat, ident.1 = "Senescent T cells", ident.2 = "Non-senescent T cells", test.use = "MAST")
volcano_plotting(marker_list, ident.1 = "Senescent T cells", ident.2 = "Non-senescent T cells")
ggsave(paste0(output_figs, "volcano_plot_sample_senes_v_non-senes.png"))





seurat_obj_Tcells@meta.data <- seurat_obj_Tcells@meta.data %>%
    mutate(primary = case_when(
        primary_sample %in% c("CUP1") ~ "CUP",
        primary_sample %in% c("Col1", "Col2") ~ "Col",
        primary_sample %in% c("Lung1") ~ "Lung",
        primary_sample %in% c("Mel1", "Mel2a", "Mel2b", "Mel3") ~ "Mel",
        TRUE ~ "Other"
    ))

pseudo_seurat_2 <- AggregateExpression(seurat_obj_Tcells, assays = "RNA", return.seurat = T, group.by = c("primary", "cells_of_interest"))
Idents(pseudo_seurat_2) <- "cells_of_interest"

marker_list_2 <- FindMarkers(pseudo_seurat_2, ident.1 = "Senescent T cells", ident.2 = "Non-senescent T cells", test.use = "MAST")
volcano_plotting(marker_list_2, ident.1 = "Senescent T cells", ident.2 = "Non-senescent T cells")
ggsave(paste0(output_figs, "volcano_plot_primary_senes_v_non-senes.png"))


# each 'cell' is a donor-condition-celltype pseudobulk profile

Idents(seurat_obj_Tcells) <- "cells_of_interest"
marker_list_3 <- FindMarkers(seurat_obj_Tcells, ident.1 = "Senescent T cells", ident.2 = "Non-senescent T cells", test.use = "MAST")
volcano_plotting(marker_list, ident.1 = "Senescent T cells", ident.2 = "Non-senescent T cells")
ggsave(paste0(output_figs, "volcano_plot_all_senes_v_non-senes.png"))


marker_list <- FindMarkers(seurat_obj_Tcells, ident.1 = "Senescent T cells", ident.2 = "Non-senescent T cells", test.use = "wilcox")
```




```{R module additiion senepy}
use_condaenv("senepy", required = TRUE) # name of the conda environment, in this case it is also named senepy

sp <- import("senepy")
hubs <- sp$load_hubs(species = "Human")
hubs
unique(hubs$metadata$tissue) # to get all unique tissues

hubs$metadata %>% head()
```


```{R tutorial}
hubs$metadata[hubs$metadata$tissue %in% c("blood"), ]

hubs$metadata[hubs$metad]
merge_results <- hubs$merge_hubs(hubs$metadata,
    new_name = "Universal",
    calculate_thresh = TRUE,
    p_thres = 0.01
)
hubs %>% str()
hubs$metadata
hubs$hubs[["('hippocampus', 'excitatory neuron', 0)"]][[1]]
hubs$hubs[["Universal"]][[1]]
universal_sig
universal_sig <- sapply(hubs$hubs[["Universal"]], function(x) x[[1]])
universal_sig_2 <- sapply(hubs$hubs[["Universal"]], function(x) x[[2]])
names(universal_sig_2) <- universal_sig


uni_sig_7 <- universal_sig_2[universal_sig_2 > 7]
uni_sig_8 <- universal_sig_2[universal_sig_2 > 8]
uni_sig_9 <- universal_sig_2[universal_sig_2 > 9]
uni_sig_10 <- universal_sig_2[universal_sig_2 > 10]
uni_sig_11 <- universal_sig_2[universal_sig_2 > 11]


universal_sig_2 %>% summary()
```

```{R }
sig_names <- names(hubs$hubs)
immune_sigs <- c(1:14, 19, 20, 21, 30, 33, 34, 35, 41, 42, 50, 51, 52, 53, 60)
signature_genes <- lapply(immune_sigs, function(num) {
    sapply(hubs$hubs[[sig_names[[num]]]], function(x) x[[1]])
})
names(signature_genes) <- sig_names[immune_sigs]

merge_results <- hubs$merge_hubs(hubs$metadata[immune_sigs, ],
    new_name = "immune",
    calculate_thresh = TRUE,
    p_thres = 0.01
)

immune_sig <- sapply(hubs$hubs[["immune"]], function(x) x[[1]])
immune_sig_2 <- sapply(hubs$hubs[["immune"]], function(x) x[[2]])
names(immune_sig_2) <- immune_sig

immune_sig_3 <- immune_sig_2[immune_sig_2 > 3]
immune_sig_4 <- immune_sig_2[immune_sig_2 > 4]
immune_sig_5 <- immune_sig_2[immune_sig_2 > 5]
immune_sig_6 <- immune_sig_2[immune_sig_2 > 6]
immune_sig_7 <- immune_sig_2[immune_sig_2 > 7]
```

```{R list of signatures}
signatures <- list(
    uni_no = universal_sig,
    uni_7 = names(uni_sig_7),
    uni_8 = names(uni_sig_8),
    uni_9 = names(uni_sig_9),
    uni_10 = names(uni_sig_10),
    uni_11 = names(uni_sig_11),
    imu_3 = names(immune_sig_3),
    imu_4 = names(immune_sig_4),
    imu_5 = names(immune_sig_5),
    imu_6 = names(immune_sig_6),
    imu_7 = names(immune_sig_7)
)
```


```{R adding signatures}
seurat_module_senepy <- AddModuleScore_UCell(seurat_obj_Tcells,
    features = signatures
)

seurat_module_senepy@meta.data %>% colnames()
wilcox.test(uni_7_UCell ~ cells_of_interest, data = seurat_module_senepy@meta.data)
wilcox.test(uni_8_UCell ~ cells_of_interest, data = seurat_module_senepy@meta.data)
wilcox.test(uni_9_UCell ~ cells_of_interest, data = seurat_module_senepy@meta.data)
wilcox.test(uni_10_UCell ~ cells_of_interest, data = seurat_module_senepy@meta.data) # no
wilcox.test(uni_11_UCell ~ cells_of_interest, data = seurat_module_senepy@meta.data)

wilcox.test(imu_3_UCell ~ cells_of_interest, data = seurat_module_senepy@meta.data)
wilcox.test(imu_4_UCell ~ cells_of_interest, data = seurat_module_senepy@meta.data) # no
wilcox.test(imu_5_UCell ~ cells_of_interest, data = seurat_module_senepy@meta.data)
wilcox.test(imu_6_UCell ~ cells_of_interest, data = seurat_module_senepy@meta.data)
wilcox.test(imu_7_UCell ~ cells_of_interest, data = seurat_module_senepy@meta.data)

VlnPlot(seurat_module_senepy, features = "uni_7_UCell")


VlnPlot(seurat_module_senepy, features = "uni_8_UCell")
VlnPlot(seurat_module_senepy, features = "uni_9_UCell")
VlnPlot(seurat_module_senepy, features = "uni_10_UCell")
VlnPlot(seurat_module_senepy, features = "uni_11_UCell")

VlnPlot(seurat_module_senepy, features = "imu_3_UCell")
VlnPlot(seurat_module_senepy, features = "imu_4_UCell")
VlnPlot(seurat_module_senepy, features = "imu_5_UCell")
VlnPlot(seurat_module_senepy, features = "imu_6_UCell")
VlnPlot(seurat_module_senepy, features = "imu_7_UCell")


Idents(seurat_module_senepy) <- "cells_of_interest"
```

```{R test for significance}
seurat_module_senepy@meta.data %>% colnames()
wilcox.test(signature_1_UCell ~ cells_of_interest, data = seurat_module_senepy@meta.data)

Idents(seurat_module_senepy) <- "cells_of_interest"
VlnPlot(seurat_module_senepy, features = "signature_1_UCell")
```

```{R plotting features}
features <- FeaturePlot(seurat_module_senepy,
    reduction = paste0("umap.harmony.", reduction_name),
    features = c("uni_7_UCell", "uni_no_UCell"), order = TRUE
) & NoAxes()
features


seurat_object <- SmoothKNN(seurat_module_senepy,
    signature.names = c("uni_7_UCell", "uni_no_UCell"),
    reduction = "harmony_pca.Tcells"
)
features <- FeaturePlot(seurat_object,
    reduction = paste0("umap.harmony.", reduction_name),
    features = c("uni_7_UCell_kNN", "uni_no_UCell_kNN"), order = TRUE
) & NoAxes()
features


Idents(seurat_module_senepy) %>% table()

Idents(seurat_module_senepy) <- "cells_of_interest"
VlnPlot(seurat_module_senepy, features = c("uni_7_UCell", "uni_no_UCell"))
Idents(seurat_object) <- "cells_of_interest"

VlnPlot(seurat_object, features = c("uni_7_UCell_kNN", "uni_no_UCell_kNN"))
```




```{R suppl}
# seurat_obj_Tcells@meta.data %>% colnames()
res_values <- c(0.01, 0.05, 0.07, 0.1)
# seurat_obj_Tcells <- FindNeighbors(seurat_obj_Tcells, reduction = paste0("harmony.", reduction_name), dims = 1:25)
seurat_obj_Tcells <- FindClusters(seurat_obj_Tcells, resolution = res_values, algorithm = 4)



resolution_columns <- grep("^RNA_snn_res\\.",
    colnames(seurat_obj_Tcells@meta.data),
    value = TRUE
)

umap_resolution_combined <- DimPlot(
    object = seurat_obj_Tcells,
    reduction = paste0("umap.harmony.", reduction_name),
    group.by = resolution_columns,
    pt.size = 0.1,
    label = TRUE
) & NoLegend() &
    theme(plot.title = element_text(size = 10)) &
    NoAxes()
umap_resolution_combined


Idents(seurat_obj_Tcells) <- "RNA_snn_res.0.1"
marker_list <- FindAllMarkers(
    object = seurat_obj_Tcells,
    # ident.1 = "High_mt", ident.2 = "low_mt",
    only.pos = F,
    min.pct = 0.25,
    logfc.threshold = 0.25
)
VlnPlot(seurat_obj_Tcells, features = c("percent_mt", "nCount_RNA", "nFeature_RNA"))
VlnPlot(seurat_obj_Tcells, features = c("percent_mt", "nCount_RNA", "nFeature_RNA"))


excel_sheet <- function(markers, output_dir, name) {
    library(writexl)
    print(paste0("Output will be put in: ", output_dir, name, ".xlsx"))
    if (file.exists(output_dir)) {
        markers %>%
            arrange(cluster, desc(avg_log2FC)) %>% # Arrange within each cluster
            group_by(cluster) %>%
            select(cluster, pct.1, pct.2, p_val, p_val_adj, avg_log2FC, gene) %>%
            group_split() %>% # Split into list by 'cluster'
            setNames(unique(markers$cluster)) %>% # Name list elements
            writexl::write_xlsx(paste0(output_dir, name, ".xlsx"))
    } else {
        stop("Directory does not exist")
    }
}
excel_sheet(marker_list, output_excel, "interesting_results")
```



